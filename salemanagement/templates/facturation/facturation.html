{% extends "index.html" %}

{% block title %}Factuation{% endblock %}

{% block content %}
<style>
    .tva-select {
    width: 100px !important;
}
</style>
    <div class="container-fluid">
       
        <div class="row">
                <!-- Ajoutez ces balises où vous voulez afficher les onglets -->
            <ul class="nav nav-tabs" id="myTabs" role="tablist">
                <li class="nav-item">
                    <a class="nav-link  font-weight-bold text-dark" id="proforma-tab" data-toggle="tab" href="#proforma" role="tab" aria-controls="proforma" aria-selected="true">Factures Proforma</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link active font-weight-bold text-dark " id="normale-tab" data-toggle="tab" href="#normale" role="tab" aria-controls="normale" aria-selected="false">Factures Normales</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link font-weight-bold text-dark" id="avoir-tab" data-toggle="tab" href="#avoir" role="tab" aria-controls="avoir" aria-selected="false">Factures d'Avoir</a>
                </li>
            </ul>
        
            <!-- Ajoutez ces divs pour afficher le contenu des onglets -->
            <div class="container-fluid">
                <div class="tab-content" id="myTabsContent">
                    <div class="tab-pane fade" id="proforma" role="tabpanel" aria-labelledby="proforma-tab">
                        <!-- Contenu du tableau Factures Proforma ici -->
                    
                        <div class="col-sm-12 mt-5 mb-5">
                            <div class="card shadow mb-4">
                                        <div class="card-header  py-3 d-flex flex-row align-items-center justify-content-between">
                                            <h6 class="m-0 font-weight-bold text-primary"> Liste des Factures proforma</h6>
                                            <div class="ml-auto">
                                                <button class="btn bg-gradient-primary ml-2 text-light " id="creerfactureproforma" onclick="affichecreationFacturation(1,'none','block')"><span class="icon text-light-50"><i class="fas fa-arrow-right"></i></span> Créer Facture Proforma </button>
                                            </div>
                                        </div>
                                        <div class="card-body table-responsive">
                                            <table class="table table-bordered" id="dataTableFacturesProforma" width="100%" cellspacing="0">
                                                <thead>
                                                    <tr class="m-0 font-weight-bold bg-light text-dark">
                                                    
                                                        <th>Num</th>
                                                        <th>Date</th>
                                                        <th>Client</th>
                                                        <th>Utilisateur</th>
                                                        <th>Action</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    {% for facture in facture_proforma %}
                                                    
                                                    <tr>
                                                    
                                                        <td>{{ facture.num_fac }}</td>
                                                        <td>{{ facture.date_facture }}</td>
                                                        <td>{{ facture.client.nom }}</td>
                                                        <td>{{ facture.user.username }}</td>
                                                    
                                                        <td class="project-actions text-left">
                                                    
                                                            <button type="button" class="detail-button btn btn-circle btn-sm btn-primary"  id="detail-button" onclick="detailfacture('{{facture.num_fac }}','{{facture.id }}','{{facture.totalmontantht }}','{{facture.totalmontantttc }}','{{facture.client.id }}','{{facture.type_facture_id }}')" data-id="{{ facture.id }}" >
                                                            <i class="fas fa-pencil-alt" data-id="{{ facture.id }}"></i> </button>
                                                            <a class="btn btn-circle btn-sm btn-secondary"  href="{% url 'generate_pdf_facture' facture.id %}" target="_blank"> <i class="fas fa-print" data-toggle="tooltip" title="Imprimer">
                                                            </i></a>
                                                        <a class="btn btn-circle btn-sm btn-dark" data-toggle="modal" data-target="#deletefactureModal{{ facture.id }}">
                                                        <i class="fas fa-trash" data-toggle="tooltip" title="Supprimer">
                                                        </i></a>
                                                        
                                                        <div class="modal fade" id="deletefactureModal{{ facture.id }}" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel"
                                                        aria-hidden="true">
                                                            <div class="modal-dialog" role="document">
                                                                <div class="modal-content">
                                                                    <div class="modal-header">
                                                                        <h5 class="modal-title" id="exampleModalLabel">Are you sure to delete this bill {{facture.num_fac}}</h5>
                                                                        <button class="close" type="button" data-dismiss="modal" aria-label="Close">
                                                                            <span aria-hidden="true">×</span>
                                                                        </button>
                                                                    </div>
                                                                    <div class="modal-body">Select "delete" below if you are ready to delete this bill {{facture.num_fac}}.</div>
                                                                    <div class="modal-footer">
                                                                        <button class="btn btn-secondary" type="button" data-dismiss="modal">Cancel</button>
                                                                        <a class="btn btn-primary" href="{% url 'annulerfacture' facture.id %}">delete</a>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    
                                                        </td>                            
                                                </tr>
                                                
                                                {% endfor %}
                                                </tbody>
                                            </table>
                                        </div>
                            </div>
                        </div>
                        
                    </div>
                    <div class="tab-pane fade show active" id="normale" role="tabpanel" aria-labelledby="normale-tab">
                        <!-- Contenu du tableau Factures Normales ici -->
                        <div class="col-sm-12 mt-5 mb-5">
                            <div class="card shadow mb-4">
                                <!-- Reproduisez le contenu du premier tableau ici et adaptez-le selon vos besoins -->
                                <div class="card-header  py-3 d-flex flex-row align-items-center justify-content-between">
                                    <h6 class="m-0 font-weight-bold text-primary">Liste des Factures</h6>
                                    <div class="ml-auto">
                                        <button class="btn bg-gradient-primary ml-2 text-light" id="creerfacturenormale" onclick="affichecreationFacturation(2,'none','block')"><span class="icon text-light-50"></span><i class="fas fa-arrow-right"></i></span> Créer Facture Normale</button>
                                    </div>
                                </div>
                                <div class="card-body table-responsive">
                                    <table class="table table-bordered" id="dataTableFactureNormale" width="100%" cellspacing="0">
                                        <thead>
                                            <tr class="m-0 font-weight-bold bg-light text-dark">
                                            
                                                <th>Num</th>
                                                <th>Date</th>
                                                <th>Client</th>
                                                <th>Utilisateur</th>
                                                <th>Action</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {% for facture in facture_normale %}
                                            
                                            <tr>
                                            
                                                <td>{{ facture.num_fac }}</td>
                                                <td>{{ facture.date_facture }}</td>
                                                <td>{{ facture.client.nom }}</td>
                                                <td>{{ facture.user.username }}</td>
                                            
                                                <td class="project-actions text-left">
                                            
                                                    <button type="button" class="detail-button btn btn-circle btn-sm btn-primary"  id="detail-button" onclick="detailfacture('{{facture.num_fac }}','{{facture.id }}','{{facture.totalmontantht }}','{{facture.totalmontantttc }}','{{facture.client.id }}','{{facture.type_facture_id}}')" data-id="{{ facture.id }}">
                                                    <i class="fas fa-pencil-alt" data-id="{{ facture.id }}"></i> </button>
                                                    <a class="btn btn-circle btn-sm btn-secondary"  href="{% url 'generate_pdf_facture' facture.id %}" target="_blank"> <i class="fas fa-print" data-toggle="tooltip" title="Imprimer">
                                                    </i></a>
                                                <!-- <a class="btn btn-circle btn-sm btn-dark" data-toggle="modal" data-target="#deletefactureModal{{ facture.id }}">
                                                <i class="fas fa-trash" data-toggle="tooltip" title="Supprimer">
                                                </i></a> -->
                                                
                                                <div class="modal fade" id="deletefactureModal{{ facture.id }}" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel"
                                                aria-hidden="true">
                                                    <div class="modal-dialog" role="document">
                                                        <div class="modal-content">
                                                            <div class="modal-header">
                                                                <h5 class="modal-title" id="exampleModalLabel">Are you sure to delete this facture {{facture.num_fac}}</h5>
                                                                <button class="close" type="button" data-dismiss="modal" aria-label="Close">
                                                                    <span aria-hidden="true">×</span>
                                                                </button>
                                                            </div>
                                                            <div class="modal-body">Select "delete" below if you are ready to delete this livraison {{facture.num_fac}}.</div>
                                                            <div class="modal-footer">
                                                                <button class="btn btn-secondary" type="button" data-dismiss="modal">Cancel</button>
                                                                <a class="btn btn-primary" href="">delete</a>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            
                                                </td>                            
                                        </tr>
                                        
                                        {% endfor %}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="tab-pane fade" id="avoir" role="tabpanel" aria-labelledby="avoir-tab">
                        <!-- Contenu du tableau Factures d'Avoir ici -->
                        <div class="col-sm-12 mt-5 mb-5">
                            <div class="card shadow mb-4">
                                <!-- Reproduisez le contenu du premier tableau ici et adaptez-le selon vos besoins -->
                                <div class="card-header py-3 d-flex flex-row align-items-center justify-content-between ">
                                    <h6 class="m-0 font-weight-bold text-primary">Listes des Factures d'avoir</h6>
                                    <div class="ml-auto">
                                        <button class="btn bg-gradient-primary ml-2 text-light" id="creeravoirfacture" onclick="affichecreationFacturation(3,'block','none')"><span class="icon text-light-50"></span><i class="fas fa-arrow-right"></i></span> Créer Avoir sur Facture</button>
                                    </div>
                                </div>
                                <div class="card-body table-responsive">
                                    <table class="table table-bordered" id="dataTableFactureAvoir" width="100%" cellspacing="0">
                                        <thead>
                                            <tr class="m-0 font-weight-bold bg-light text-dark">
                                            
                                                <th>Num</th>
                                                <th>Date</th>
                                                <th>Client</th>
                                                <th>Utilisateur</th>
                                                <th>Action</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {% for facture in facture_avoir %}
                                            
                                            <tr>
                                            
                                                <td>{{ facture.num_fac }}</td>
                                                <td>{{ facture.date_facture }}</td>
                                                <td>{{ facture.client.nom }}</td>
                                                <td>{{ facture.user.username }}</td>
                                            
                                                <td class="project-actions text-left">
                                            
                                                    <button type="button" class="detail-button btn btn-circle btn-sm btn-primary"  id="detail-button" onclick="detailfacture('{{facture.num_fac }}','{{facture.id }}','{{facture.totalmontantht }}','{{facture.totalmontantttc }}','{{facture.client.id }}','{{facture.type_facture_id }}')" data-id="{{ facture.id }}">
                                                    <i class="fas fa-pencil-alt" data-id="{{ facture.id }}"></i> </button>
                                                    <a class="btn btn-circle btn-sm btn-secondary"  href="{% url 'generate_pdf_facture' facture.id %}" target="_blank"> <i class="fas fa-print" data-toggle="tooltip" title="Imprimer">
                                                    </i></a>
                                                <!-- <a class="btn btn-circle btn-sm btn-dark" data-toggle="modal" data-target="#deletefactureModal{{ facture.id }}">
                                                <i class="fas fa-trash" data-toggle="tooltip" title="Supprimer">
                                                </i></a> -->
                                                
                                                <div class="modal fade" id="deletefactureModal{{ facture.id }}" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel"
                                                aria-hidden="true">
                                                    <div class="modal-dialog" role="document">
                                                        <div class="modal-content">
                                                            <div class="modal-header">
                                                                <h5 class="modal-title" id="exampleModalLabel">Are you sure to delete this facture {{facture.num_fac}}</h5>
                                                                <button class="close" type="button" data-dismiss="modal" aria-label="Close">
                                                                    <span aria-hidden="true">×</span>
                                                                </button>
                                                            </div>
                                                            <div class="modal-body">Select "delete" below if you are ready to delete this livraison {{facture.num_fac}}.</div>
                                                            <div class="modal-footer">
                                                                <button class="btn btn-secondary" type="button" data-dismiss="modal">Cancel</button>
                                                                <a class="btn btn-primary" href="">delete</a>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            
                                                </td>                            
                                        </tr>
                                        
                                        {% endfor %}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>  
        <div class="col-sm-12 mx-auto" id="creationfacturation" style="display:none;" >
            <div class="card shadow mb-4 ">
                <div class="card-header py-3 d-flex flex-row align-items-center justify-content-between">
                    <h6 class="m-0 font-weight-bold text-primary">Creer une facture</h6>
                </div>
               
                <form method="post" action="" autocomplete="off" class="form-horizontal" id="formUp">
                    {% csrf_token %}
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-4">
                                <div class="form-group">
                                    <label for="Codeda">N° Facture</label>
                                    <input type="text" class="form-control" name="num_fac" id="num_fac" value="" disabled>
                                    <input type="text" class="form-control" name="idfac" id="idfac" value="" hidden>
                                    <input type="text" class="form-control" name="type_facture_id" id="type_facture_id" value="" style="display: none;">
                                    <input type="text" class="form-control" name="" id="bttn" value="" style="display: none;">
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-group">
                                    <label>Date Facture</label>
                                    <div class="input-group">
                                        <div class="input-group-prepend">
                                            <div class="input-group-text">
                                                <i class="fa fa-calendar"></i>
                                            </div>
                                        </div>
                                        <input class="form-control fom-control-sm" name="date_facture" id="datefac" value="{{ value|date:'Y-m-d\TH:i' }}" placeholder="JJ/MM/AAAA" type="datetime-local">
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-group">
                                    <label>Client</label>
                                    <select name="client_id" id="clientfac" class="form-control custom-select">
                                        <option value="">Sélectionnez le client</option>
                                        {% for client in clients %}
                                            <option value="{{client.id}}">
                                                {{client.nom}} 
                                            </option>
                                        {% endfor %}
                                    </select>
                                </div>
                            </div>
                        </div>
                       
                        <div class="row" id="fac_original">
                            <div class="col-md-4">
                                <div class="form-group">
                                    <label for="num_fac_origine">N° facture d'origine</label>
                                    <div class="input-group">
                                        <input type="text" class="form-control" name="num_fac_origine" id="num_fac_origine" value="" readonly>
                                        <input type="text" class="form-control"  id="num_fac_origine_id" value="" hidden>
                                        <div class="input-group-append">
                                            <a data-toggle="modal" href="#modalfacture" id="addfacture" class="btn btn bg-gradient-info text-light">
                                                <span class="icon text-white-50">
                                                    <i class="fas fa-arrow-left"></i>
                                                </span>
                                                <span class="text">Choisir facture</span>
                                            </a>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                                   
                        
                        <div class="row">
                            <div class="col-md-2">
                                <a data-toggle="modal" href="#modalarticle" id="addarticle" class="btn btn bg-gradient-success  text-light ml-2 btn-icon-split">
                                        <span class="icon text-white-50">
                                            <i class="fas fa-arrow-right"  ></i>
                                        </span>
                                        <span class="text">Ajouter un article</span>
                                </a>
                            </div>
                        </div>               
                          
                                   
                                    <br>
                        <div class="form-group" style="display:none;">
                          
    
                            <input class="form-control form-control-sm" name="code" id="codeart" value=""
                                type="text">
    
                            <input class="form-control form-control-sm" name="description" id="descriptionart" value=""
                                type="text">
    
                            <input class="form-control form-control-sm" id="idart" value="" type="text">
    
                            <input class="form-control form-control-sm" value="" id="prix_unitaire" type="text">
                           
                            
                        </div>
    
                        <br>
                        <button id="ajouter-ligne" class="btn btn-primary" hidden>Ajouter une ligne</button>
                        <div class="card card-info">
                            <div class="card-header">
                                <h3 class="card-title">Détails articles</h3>
                            </div>
    
                            <div class="card-body table-responsive p-0">
                                <table class="table table-bordered  text-nowrap tabart" id="tabart">
                                    <thead>
                                        <tr>
                                            <th>code</th>
                                            <th>Designation</th>
                                            <th>qte</th>
                                            <th>prix unitaire</th>
                                            <th>remise</th>
                                            <th>TVA</th>
                                            <th>prix HTTC</th>
                                            <th>prix TTC</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="bodart"></tbody>
                                    <tfoot id="footart">
                                     
                                    </tfoot>
                                </table>
    
                            </div>
    
                        </div>
    
                    </div>
            </div>
            <!-- /.card-body -->
    
            <div class="card-footer">
                <button type="submit" class="btn btn bg-gradient-info  text-light ml-2" id="ajouterfacturation" style="display: none">Ajouter</button>
                <button type="submit" class="btn btn bg-gradient-success  text-light ml-2" id="modifierfacturation" style="display: none" >Modifier</button>
                </form>
            </div>
        </div>
        <div class="modal" id="modalarticle">
            <div class="modal-dialog modal-xl" role="document">
                <div class="modal-content modal-content-demo">
                    <div class="modal-header">
                        <h6 class="modal-title">Ajouter un article</h6><button aria-label="Close" class="close"
                            data-dismiss="modal" type="button"><span aria-hidden="true">&times;</span></button>
                    </div>
                    <div class="modal-body">

                        <div class="table-responsive">
                            <table id="dataTableArticle" style="text-align: center"
                                class="table table-striped table-bordered mb-0 text-sm-nowrap text-lg-nowrap text-xl-nowrap">

                                <thead>
                                    <tr>

                                        <th class="border-bottom-0">Code article</th>
                                        <th class="border-bottom-0">Désignation </th>
                                        <th class="border-bottom-0">Qte </th>
                                        <th class="border-bottom-0">prix unitaire </th>
                                        <th class="border-bottom-0">Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for article in articles %}
                                        <tr>
                                            <td>{{ article.code }}</td>
                                            <td>{{ article.description }}</td>
                                            <td>{{ article.stock }}</td>
                                            <td>{{ article.prix_unitaire }}</td>
                                            <td>
                                                
                                                    <button id="ajouter-ligne" class="btn btn-success"  onclick="ajouterLigne('{{ article.code }}', '{{ article.id }}','{{ article.description }}','{{ article.stock }}', '{{ article.prix_unitaire }}')"><i class="fa fa-plus"></i></button>

                                            </td>
                                        </tr>
                                        {% endfor %}
                                </tbody>
                                <tfoot>
                                    <th class="border-bottom-0">Code article</th>
                                    <th class="border-bottom-0">Désignation </th>
                                    <th class="border-bottom-0">Qte </th>
                                    <th class="border-bottom-0">prix unitaire </th>
                                    <th class="border-bottom-0">Actions</th>
                                </tfoot>
                            </table>
                        </div>

                    </div>
                </div>
            </div>

        </div> 
        <div class="modal" id="modalfacture">
            <div class="modal-dialog modal-xl" role="document">
                <div class="modal-content modal-content-demo">
                    <div class="modal-header">
                        <h6 class="modal-title">Choisir la facture</h6><button aria-label="Close" class="close"
                            data-dismiss="modal" type="button"><span aria-hidden="true">&times;</span></button>
                    </div>
                    <div class="modal-body">

                        <div class="table-responsive">
                            <table id="dataTableFactureOrigine" style="text-align: center"
                                class="table table-striped table-bordered mb-0 text-sm-nowrap text-lg-nowrap text-xl-nowrap">

                                <thead>
                                    <tr>

                                        <th class="border-bottom-0">N° Facture</th>
                                        <th class="border-bottom-0">Date</th>
                                        <th class="border-bottom-0">Client </th>
                                        <th class="border-bottom-0">Utilisateur </th>
                                        <th class="border-bottom-0">Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for facture in facture_normale %}
                                        <tr>
                                            <td>{{ facture.num_fac }}</td>
                                            <td>{{ facture.date_facture }}</td>
                                            <td>{{ facture.client.nom }}</td>
                                            <td>{{ facture.user.username }}</td>
                                            <td>
                                                
                                                    <button id="detail-button-original" class="btn btn-dark detail-button-original"  data-id="{{ facture.id }}" onclick="detailfactureoriginal('{{facture.num_fac }}','{{facture.id }}','{{facture.totalmontantht }}','{{facture.totalmontantttc }}','{{facture.client.id }}')"><i class="fa fa-plus"></i></button>

                                            </td>
                                        </tr>
                                        {% endfor %}
                                </tbody>
                                <tfoot>
                                    <th class="border-bottom-0">Code article</th>
                                    <th class="border-bottom-0">Désignation </th>
                                    <th class="border-bottom-0">Qte </th>
                                    <th class="border-bottom-0">prix unitaire </th>
                                    <th class="border-bottom-0">Actions</th>
                                </tfoot>
                            </table>
                        </div>

                    </div>
                </div>
            </div>

        </div> 
    </div>
    <!-- Ajoutez ces scripts JavaScript à la fin de votre page HTML -->
<script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>
<script> function detailfactureoriginal(numfac,numfacid,montantht,montttc,client)
{
    console.log(montantht,montttc);
    initFooter();
    document.getElementById("num_fac_origine").value = numfac;
    document.getElementById("num_fac_origine_id").value = numfacid;
    document.getElementById("totalmontantht").value = montantht;
    document.getElementById("totalmontantttc").value = montttc;
    document.getElementById("clientfac").value = client;

   

    $('#modalfacture').modal('hide'); 



}
function detailfacture(numfac,numfacid,montantht,montttc,client,typefacture)
{
    if (typefacture == 3) {
        affichecreationFacturation('','block','none');
        // document.getElementById("addfacture").style.display='none'
    } else {
        affichecreationFacturation('','none','block');
    }
    
    console.log(montantht,montttc);
    initFooter();
    document.getElementById("num_fac").value = numfac;
    document.getElementById("num_fac_origine_id").value = numfacid;
    document.getElementById("totalmontantht").value = montantht;
    document.getElementById("totalmontantttc").value = montttc;
    document.getElementById("clientfac").value = client;


}
</script>
<script>
    $(document).ready(function() {
        $('#myTabs a').on('click', function (e) {
            e.preventDefault()
            $(this).tab('show')
            document.getElementById("creationfacturation").style.display ='none';

        })
    })
</script>
<script>
    function initFooter() {
    var footerRow = $('#footart');

    // Créer les éléments HTML pour le pied du tableau
    var html = '<tr>' +
                   '<td colspan="6">Total</td>' +
                   '<td><input class="form-control form-control-sm" name="totalmontantht" id="totalmontantht" value="" readonly></td>' +
                   '<td><input class="form-control form-control-sm" name="totalmontantttc" id="totalmontantttc" value="" readonly></td>' +
                   '<td></td>' +
               '</tr>';

    // Ajouter le HTML au pied du tableau
    footerRow.html(html);
}
</script>

    <script>
        function affichecreationFacturation(typeFacture,fac_origin,btnarticle)
        { initFooter();
            console.log(typeFacture);
            document.getElementById('type_facture_id').value = typeFacture;
            document.getElementById("fac_original").style.display =fac_origin;
            document.getElementById("addarticle").style.display =btnarticle;
            const tbodyElmnt3 = document.querySelector("#bodart"); //important
            tbodyElmnt3.innerHTML = '';
            document.getElementById("creationfacturation").style.display ='block';
            document.getElementById("modifierfacturation").style.display ='none';
            document.getElementById("num_fac").value ='';
            // document.getElementById("dateliv").value = '';
            document.getElementById("clientfac").value ='';
            document.getElementById("num_fac_origine").value ='';
            // document.getElementById("totalmontantht").value ='';
            // document.getElementById("totalmontantttc").value ='';
            
            // document.getElementById('showart').style.display = 'block';
            var updateUrl = "{% url 'addfacturation'  %}";
            document.getElementById("formUp").setAttribute('action', updateUrl);
          
            // document.getElementById("modifierclient").style.display ='none';
            document.getElementById("ajouterfacturation").style.display ='block';
        }
        
          </script> 
          <script>
              function onDeleteRow(e) {
            if (!e.target.classList.contains("deleteBtn")) {
                return;
            }

            const btn = e.target;
            btn.closest("tr").remove();
        }
         const tbodyElmnt = document.querySelector("#bodart");
         const tableElmnt = document.querySelector("#tabart");
         tableElmnt.addEventListener("click", onDeleteRow);
         
          function ajouterLigne (j, i, k, z, p)  {
            var modal = $('#modalarticle');
            const table = document.getElementById('tabart').getElementsByTagName('tbody')[0];
            const newRow = table.insertRow();
            const cell1 = newRow.insertCell(0);
            const cell2 = newRow.insertCell(1);
            const cell3 = newRow.insertCell(2);
            const cell4 = newRow.insertCell(3);
            const cell5 = newRow.insertCell(4);
            const cell6 = newRow.insertCell(5);
            const cell7 = newRow.insertCell(6);
            const cell8 = newRow.insertCell(7);
            const cell9 = newRow.insertCell(8);
            console.log(j);
            cell1.innerHTML = '<input class="form-control form-control-sm" id="codeart" name="code[]" value="' + j + '" type="text" readonly>';
            cell2.innerHTML = ' <input class="form-control form-control-sm" name="article_id" id="idart" value="' + i + '" type="text" readonly style="display:none;"><input class="form-control form-control-sm" name="libart[]" id="libart" value="' + k + '" type="text" readonly>';
            cell3.innerHTML = '<input class="form-control form-control-sm" name="qte" id="qteart" value="0" placeholder="" type="number" min="1" >';
            cell4.innerHTML = '<input class="form-control form-control-sm prix_uart" name="prix_u" id="prix_uart"   value="' + p +'"placeholder="" type="text"  readonly>';
            cell5.innerHTML = '<input class="form-control form-control-sm " name="remise" id="remise"   value="0" placeholder="" type="number" min="0">';
            cell6.innerHTML = '<select class="form-control form-control-sm tva-select" name="TVA" id="TVA" ><option value="">%</option><option value="0">0%</option><option value="19">19%</option></select>';
            cell7.innerHTML = '<input class="form-control form-control-sm " name="montantht" id="montantht"   value=""   readonly>';
            cell8.innerHTML = '<input class="form-control form-control-sm " name="montantttc" id="montantttc"   value=""    readonly>';
            cell9.innerHTML = '<a class="deleteBtn btn  btn-circle btn-sm btn-danger"  title="Delete"><i class="fa fa-trash"></i></a>';
            initFooter();
            $('#modalarticle').modal('hide'); };
        document.getElementById('ajouter-ligne').addEventListener('click', ajouterLigne);
       
</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.1/moment.min.js"></script>
<script>
    function recuplivraison(numfac, idfac,date_fac, clientfac) {
        var dateFacturationString = date_fac; // Remplacez par la valeur réelle de date_liv
        var formattedDate = moment(dateFacturationString, "MMM. DD, YYYY, h:mm:ss a").format("YYYY-MM-DDTHH:mm:ss");
 
        document.getElementById("creationfacturation").style.display ='block';
        document.getElementById("num_fac").value = numfac;
        document.getElementById("idfac").value = idfac;
        document.getElementById("datefac").value = formattedDate;
        document.getElementById("clientfac").value = clientfac;
        document.getElementById("modifierfacturation").style.display ='block';
        document.getElementById("ajouterfacturation").style.display ='none'; 


        var updateUrl = "{% url 'updatelivraison' 0 %}".replace('0', idfac);
        console.log(updateUrl);
        document.getElementById("formUp").setAttribute('action', updateUrl);
       
    }
   
</script>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
        $(document).on('click', '.detail-button-original', function() {
            var facturationId = $(this).data("id"); // Utilisez data("id") pour récupérer l'attribut data-id
            console.log(facturationId);
            if (facturationId) {
                $.ajax({
                    url: '/get_details_facture_original/' + facturationId,
                    type: "GET",
                    dataType: "json",
                    success: function(data) {
                        if (data) {
                            $('#bodart').empty();
                            $.each(data.details, function(index, detail) {
                                console.log(detail);
                                $('#bodart').append('<tr>' +
                                    '<td><input class="form-control form-control-sm" id="codeart" name="code" value="' + detail.code_article + '" type="text" readonly>' +
                                    '<td><input class="form-control form-control-sm" id=""idart name="article_id" value="' + detail.article_id + '" type="text" readonly style="display : none;"><input class="form-control form-control-sm" id="libart" name="libart[]" value="' + detail.description + '" type="text" readonly></td>' +
                                    '<td><input class="form-control form-control-sm" id="qteart" name="qte" value="' + detail.quantite_vendue + '" placeholder="" type="number" min="1" readonly></td>' +
                                    '<td><input class="form-control form-control-sm " id="pri_uart" name="prix_u" value="' + detail.prix_unitaire + '" placeholder="" type="text" readonly></td>' +
                                    '<td><input class="form-control form-control-sm custom-width" name="remise" id="remise"   value="' + detail.remise + '" placeholder="" type="number" min="0" readonly></td>'+
                                    '<td><select class="form-control form-control-sm tva-select" name="TVA" id="TVA" readonly><option value="' + detail.TVA + '">' + detail.TVA + '</option></select></td>'+
                                    '<td><input class="form-control form-control-sm " name="montantht" id="montantht"   value="' + detail.montantht + '"   readonly></td>'+
                                    '<td><input class="form-control form-control-sm " name="montantttc" id="montantttc"   value="' + detail.montantttc + '"    readonly></td>'+
                                    '<td><a class="deleteBtn btn  btn-circle btn-sm btn-danger"  title="Delete"><i class="fa fa-trash"></i></a></td>' +
                                    '</tr>');
//                                     $('#footart').append( '<tr>' +
//                                         '<td colspan="6">Total</td>' +
//                                         '<td><input class="form-control form-control-sm" name="totalmontantht" id="totalmontantht" value="" readonly></td>' +
//                                         '<td><input class="form-control form-control-sm" name="totalmontantttc" id="totalmontantttc" value="" readonly></td>' +
//                                         '<td></td>' +
//                                     '</tr>'
// );
                            });
                        } else {
                            $('#bodart').empty();
                        }
                    }
                });
            } else {
                $('#bodart').empty();
            }
        });
    </script>
    <script>
        $(document).on('click', '.detail-button', function() {
            var facturationId = $(this).data("id"); // Utilisez data("id") pour récupérer l'attribut data-id
            console.log(facturationId);
            if (facturationId) {
                $.ajax({
                    url: '/get_details_facture/' + facturationId,
                    type: "GET",
                    dataType: "json",
                    success: function(data) {
                        if (data) {
                            $('#bodart').empty();
                            $.each(data.details, function(index, detail) {
                                console.log(detail);
                                $('#bodart').append('<tr>' +
                                    '<td><input class="form-control form-control-sm" id="codeart" name="code" value="' + detail.code_article + '" type="text" readonly>' +
                                    '<td><input class="form-control form-control-sm" id=""idart name="article_id" value="' + detail.article_id + '" type="text" readonly style="display : none;"><input class="form-control form-control-sm" id="libart" name="libart[]" value="' + detail.description + '" type="text" readonly></td>' +
                                    '<td><input class="form-control form-control-sm" id="qteart" name="qte" value="' + detail.quantite_vendue + '" placeholder="" type="number" min="1" readonly></td>' +
                                    '<td><input class="form-control form-control-sm " id="pri_uart" name="prix_u" value="' + detail.prix_unitaire + '" placeholder="" type="text" readonly></td>' +
                                    '<td><input class="form-control form-control-sm custom-width" name="remise" id="remise"   value="' + detail.remise + '" placeholder="" type="number" min="0" readonly></td>'+
                                    '<td><select class="form-control form-control-sm tva-select" name="TVA" id="TVA" readonly><option value="' + detail.TVA + '">' + detail.TVA + '</option></select></td>'+
                                    '<td><input class="form-control form-control-sm " name="montantht" id="montantht"   value="' + detail.montantht + '"   readonly></td>'+
                                    '<td><input class="form-control form-control-sm " name="montantttc" id="montantttc"   value="' + detail.montantttc + '"    readonly></td>'+
                                    '<td><a class="deleteBtn btn  btn-circle btn-sm btn-danger"  title="Delete"><i class="fa fa-trash"></i></a></td>' +
                                    '</tr>');
//                                     $('#footart').append( '<tr>' +
//                                         '<td colspan="6">Total</td>' +
//                                         '<td><input class="form-control form-control-sm" name="totalmontantht" id="totalmontantht" value="" readonly></td>' +
//                                         '<td><input class="form-control form-control-sm" name="totalmontantttc" id="totalmontantttc" value="" readonly></td>' +
//                                         '<td></td>' +
//                                     '</tr>'
// );
                            });
                        } else {
                            $('#bodart').empty();
                        }
                    }
                });
            } else {
                $('#bodart').empty();
            }
        });
    </script>
<script>
$(document).ready(function () {
    $('#dataTableFacturesProforma').DataTable({
        // Autres options DataTables ici
        language: {
            search: "",
            searchPlaceholder: "Search",
            lengthMenu: " _MENU_",
            info: "Showing _START_ to _END_ of _TOTAL_ entries",
            infoEmpty: "",
            infoFiltered: "(filtered from _MAX_ total entries)",
            paginate: {
                first: "First",
                last: "Last",
                next: "Next",
                previous: "Previous"
            }
        }
    });

    $('#dataTableFactureNormale').DataTable({
        // Autres options DataTables ici
        language: {
            search: "",
            searchPlaceholder: "Search",
            lengthMenu: "_MENU_",
            info: "Showing _START_ to _END_ of _TOTAL_ entries",
            infoEmpty: "",
            infoFiltered: "(filtered from _MAX_ total entries)",
            paginate: {
                first: "First",
                last: "Last",
                next: "Next",
                previous: "Previous"
            }
        }
    });

    $('#dataTableFactureAvoir').DataTable({
        // Autres options DataTables ici
        language: {
            search: "",
            searchPlaceholder: "Search",
            lengthMenu: "_MENU_",
            info: "Showing _START_ to _END_ of _TOTAL_ entries",
            infoEmpty: "",
            infoFiltered: "(filtered from _MAX_ total entries)",
            paginate: {
                first: "First",
                last: "Last",
                next: "Next",
                previous: "Previous"
            }
        }
    });
    $('#dataTableArticle').DataTable({
        // Autres options DataTables ici
        language: {
            search: "",
            searchPlaceholder: "Search",
            lengthMenu: "_MENU_",
            info: "Showing _START_ to _END_ of _TOTAL_ entries",
            infoEmpty: "",
            infoFiltered: "(filtered from _MAX_ total entries)",
            paginate: {
                first: "First",
                last: "Last",
                next: "Next",
                previous: "Previous"
            }
        }
    });
    $('#dataTableFactureOrigine').DataTable({
        // Autres options DataTables ici
        language: {
            search: "",
            searchPlaceholder: "Search",
            lengthMenu: "_MENU_",
            info: "Showing _START_ to _END_ of _TOTAL_ entries",
            infoEmpty: "",
            infoFiltered: "(filtered from _MAX_ total entries)",
            paginate: {
                first: "First",
                last: "Last",
                next: "Next",
                previous: "Previous"
            }
        }
    });
});
</script>
<script>
// Supposons que totalMontantTTC soit une variable globale initialement à zéro
var totalMontantTTC = 0;
var totalMontantHT = 0;


$('#tabart').on('change', ".tva-select, input.form-control[name='qte'], input.form-control[name='remise']", function () {
    var row_params = {},
        row = $(this).closest("tr"),
        montantHT, montantTTC;

    row_params.quantite = $(row).find("input.form-control[name='qte']").val().replace(/,/g, ".");
    row_params.pu = $(row).find("input.form-control[name='prix_u']").val().replace(/,/g, ".");
    var selectedTva = parseFloat($(row).find(".tva-select").val()) / 100;
    var remiseValue = $(row).find("input.form-control[name='remise']").val();
    var remise = remiseValue ? parseFloat(remiseValue) / 100 : 0;

    // Calcul du montant HT en prenant en compte la remise
    var montantAvantRemise = row_params.quantite * row_params.pu;
    var montantApresRemise = montantAvantRemise - (montantAvantRemise * remise);

    // Calcul du montant TTC
    montantHT = montantApresRemise;
    tva = montantHT * selectedTva;
    montantTTC = (selectedTva === 0) ? montantHT : montantHT + tva;

    // Mise à jour des champs montantht et montantttc
    $(row).find("input.form-control[name='montantht']").val(parseFloat(montantHT).toFixed(2));
    $(row).find("input.form-control[name='montantttc']").val(parseFloat(montantTTC).toFixed(2));

    // Mettre à jour le champ totalMontantTTC
    totalMontantTTC = 0; // Remise à zéro avant la mise à jour
    totalMontantHT = 0; // Remise à zéro avant la mise à jour

    $('#tabart tbody tr').each(function () {
        var montantTTCRow = parseFloat($(this).find("input.form-control[name='montantttc']").val()) || 0;
        totalMontantTTC += montantTTCRow;

        var montantHTRow = parseFloat($(this).find("input.form-control[name='montantht']").val()) || 0;
        totalMontantHT += montantHTRow;
    });

    $('#totalmontantttc').val(parseFloat(totalMontantTTC).toFixed(2));
    $('#totalmontantht').val(parseFloat(totalMontantHT).toFixed(2));

});






</script>

    
   
    




{% endblock %}

